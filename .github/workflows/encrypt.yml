name: Auto Encrypt Protected Pages

on:
  push:
    branches: [ main, master ]  # æ ¹æ®ä½ çš„ä¸»åˆ†æ”¯åç§°è°ƒæ•´
    paths:
      - 'scr/**'  # åªç›‘å¬ scr ç›®å½•ä¸‹çš„ä»»ä½•æ–‡ä»¶å˜åŒ–

jobs:
  encrypt:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²,ä»¥ä¾¿æ­£ç¡®æäº¤
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install staticrypt
        run: npm install -g staticrypt
      
      - name: Encrypt protected pages
        run: |
          # ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿åŠ å¯†æ‰€æœ‰ scr ç›®å½•ä¸‹çš„ HTML æ–‡ä»¶
          staticrypt scr/project-finance.html "${{ secrets.ENCRYPT_PASSWORD }}" \
            -o project-finance.html \
            -r 30 \
            -t password-template.html
          
          staticrypt scr/project-jaxx.html "${{ secrets.ENCRYPT_PASSWORD }}" \
            -o project-jaxx.html \
            -r 30 \
            -t password-template.html
          
          staticrypt scr/project-speed.html "${{ secrets.ENCRYPT_PASSWORD }}" \
            -o project-speed.html \
            -r 30 \
            -t password-template.html
          
          staticrypt scr/project-loan.html "${{ secrets.ENCRYPT_PASSWORD }}" \
            -o project-loan.html \
            -r 30 \
            -t password-template.html
          
          echo "âœ… æ‰€æœ‰é¡µé¢åŠ å¯†å®Œæˆ(ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿)"
      
      - name: Commit encrypted files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ åŠ å¯†åçš„æ–‡ä»¶
          git add project-*.html
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–,æœ‰å˜åŒ–æ‰æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜åŒ–"
          else
            git commit -m "ğŸ”’ Auto-encrypt: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… åŠ å¯†æ–‡ä»¶å·²æäº¤"
          fi
